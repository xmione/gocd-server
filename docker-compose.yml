# gocd-server/docker-compose.yml

services:
  gocd-server:
    build: .
    container_name: gocd-server
    restart: unless-stopped
    ports:
      - "8153:8153"
      - "8154:8154"
    env_file:
      - .env.docker
    environment:
      - GO_SERVER_SSL_PORT=8154
      - GO_SERVER_SSL_CERTIFICATE=/etc/go/server/server.crt
      - GO_SERVER_SSL_PRIVATE_KEY=/etc/go/server/server.key
    volumes:
      - gocd_data:/godata
      - gocd_home:/home/go
      - ./certs/server.crt:/etc/go/server/server.crt:ro
      - ./certs/server.key:/etc/go/server/server.key:ro
      - ./certs/keystore.p12:/tmp/keystore.p12:ro
      - ./config/cruise-config.xml:/tmp/cruise-config.xml.template:ro
      - /var/run/docker.sock:/var/run/docker.sock

  gocd-agent-1:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: gocd-agent-1
    restart: unless-stopped
    environment:
      - GO_SERVER_URL=http://gocd-server:8153/go
      - AGENT_AUTO_REGISTER_KEY=default
      - AGENT_AUTO_REGISTER_RESOURCES=docker,linux
      - AGENT_AUTO_REGISTER_HOSTNAME=agent-1
      - AGENT_BOOTSTRAP_ARGS=-Dgo.agent.ssl.verify=false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./certs/ca.crt:/usr/local/share/ca-certificates/ca.crt:ro
      - ../pearl-hello-world:/pearl-hello-world:rw
      - ./certs:/certs:ro
    depends_on:
      - gocd-server

  gocd-agent-2:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: gocd-agent-2
    restart: unless-stopped
    environment:
      - GO_SERVER_URL=http://gocd-server:8153/go
      - AGENT_AUTO_REGISTER_KEY=default
      - AGENT_AUTO_REGISTER_RESOURCES=docker,linux
      - AGENT_AUTO_REGISTER_HOSTNAME=agent-2
      - AGENT_BOOTSTRAP_ARGS=-Dgo.agent.ssl.verify=false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./certs/ca.crt:/usr/local/share/ca-certificates/ca.crt:ro
      - ../badminton_court:/badminton_court:rw
      - ./certs:/certs:ro
    depends_on:
      - gocd-server
  
  gocd-agent-3:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: gocd-agent-3
    restart: unless-stopped
    environment:
      - GO_SERVER_URL=http://gocd-server:8153/go
      - AGENT_AUTO_REGISTER_KEY=default
      - AGENT_AUTO_REGISTER_RESOURCES=docker,linux
      - AGENT_AUTO_REGISTER_HOSTNAME=agent-3
      - AGENT_BOOTSTRAP_ARGS=-Dgo.agent.ssl.verify=false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./certs/ca.crt:/usr/local/share/ca-certificates/ca.crt:ro
      - ../badminton_court:/badminton_court:rw
      - ./certs:/certs:ro
    depends_on:
      - gocd-server
  
  gocd-agent-4:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: gocd-agent-4
    restart: unless-stopped
    environment:
      - GO_SERVER_URL=http://gocd-server:8153/go
      - AGENT_AUTO_REGISTER_KEY=default
      - AGENT_AUTO_REGISTER_RESOURCES=docker,linux
      - AGENT_AUTO_REGISTER_HOSTNAME=agent-4
      - AGENT_BOOTSTRAP_ARGS=-Dgo.agent.ssl.verify=false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./certs/ca.crt:/usr/local/share/ca-certificates/ca.crt:ro
      - ../badminton_court:/badminton_court:rw
      - ./certs:/certs:ro
    depends_on:
      - gocd-server
  
  gocd-agent-5:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: gocd-agent-5
    restart: unless-stopped
    environment:
      - GO_SERVER_URL=http://gocd-server:8153/go
      - AGENT_AUTO_REGISTER_KEY=default
      - AGENT_AUTO_REGISTER_RESOURCES=docker,linux
      - AGENT_AUTO_REGISTER_HOSTNAME=agent-5
      - AGENT_BOOTSTRAP_ARGS=-Dgo.agent.ssl.verify=false
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./certs/ca.crt:/usr/local/share/ca-certificates/ca.crt:ro
      - ../badminton_court:/badminton_court:rw
      - ./certs:/certs:ro
    depends_on:
      - gocd-server
      
volumes:
  gocd_data:
  gocd_home: