<!-- config/cruise-config.xml -->
<cruise schemaVersion="139">
  <server agentAutoRegisterKey="default" serverId="__SERVER_ID__" tokenGenerationKey="__TOKEN_GENERATION_KEY__">
    <security>
      <authConfigs>
        <authConfig id="password_file" pluginId="cd.go.authentication.passwordfile">
          <property>
            <key>PasswordFilePath</key>
            <value>/godata/config/password.properties</value>
          </property>
        </authConfig>
      </authConfigs>
      <roles>
        <role name="gocd-system-administrators">
          <users>
            <user>admin</user>
          </users>
        </role>
      </roles>
      <admins>
        <user>admin</user>
      </admins>
    </security>
  </server>

  <pipelines group="defaultGroup">
    <!-- Existing badminton_court pipeline -->
    <pipeline name="badminton_court">
      <materials>
        <git url="__GIT_REPO_URL_WITH_CREDENTIALS__" branch="master" />
      </materials>
      <stage name="build">
        <jobs>
          <job name="build_job">
            <resources>
              <resource>docker</resource>
            </resources>
            <tasks>
              <!-- Stop any existing containers -->
              <exec command="docker-compose">
                <arg>-f</arg>
                <arg>/badminton_court/docker-compose.yml</arg>
                <arg>--env-file</arg>
                <arg>/badminton_court/.env.docker</arg>
                <arg>-p</arg>
                <arg>badminton-court</arg>
                <arg>down</arg>
              </exec>
              <!-- Build all service images without cache -->
              <exec command="docker-compose">
                <arg>-f</arg>
                <arg>/badminton_court/docker-compose.yml</arg>
                <arg>--env-file</arg>
                <arg>/badminton_court/.env.docker</arg>
                <arg>--profile</arg>
                <arg>dev</arg>
                <arg>--profile</arg>
                <arg>test</arg>
                <arg>--profile</arg>
                <arg>tunnel</arg>
                <arg>--profile</arg>
                <arg>presentation</arg>
                <arg>--progress=plain</arg>
                <arg>build</arg>
                <arg>--no-cache</arg>
              </exec>
              <!-- Force recreate dev containers -->
              <exec command="docker-compose">
                <arg>-f</arg>
                <arg>/badminton_court/docker-compose.yml</arg>
                <arg>--env-file</arg>
                <arg>/badminton_court/.env.docker</arg>
                <arg>--profile</arg>
                <arg>dev</arg>
                <arg>-p</arg>
                <arg>badminton-court</arg>
                <arg>up</arg>
                <arg>-d</arg>
                <arg>--force-recreate</arg>
              </exec>
              <!-- Show service status -->
              <exec command="docker-compose">
                <arg>-f</arg>
                <arg>/badminton_court/docker-compose.yml</arg>
                <arg>--env-file</arg>
                <arg>/badminton_court/.env.docker</arg>
                <arg>--profile</arg>
                <arg>dev</arg>
                <arg>-p</arg>
                <arg>badminton-court</arg>
                <arg>ps</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
    </pipeline>
    
    <!-- pearl-hello-world pipeline -->
    <pipeline name="pearl-hello-world">
      <materials>
        <git url="__GIT_REPO_URL_WITH_CREDENTIALS__" branch="master" />
      </materials>
      <stage name="build">
        <jobs>
          <job name="build_job">
            <resources>
              <resource>docker</resource>
            </resources>
            <tasks>
              <!-- Stop and remove existing container -->
              <exec command="docker">
                <arg>stop</arg>
                <arg>pearl-hello-world</arg>
                <arg>||</arg>
                <arg>true</arg>
              </exec>
              <exec command="docker">
                <arg>rm</arg>
                <arg>pearl-hello-world</arg>
                <arg>||</arg>
                <arg>true</arg>
              </exec>
              <!-- Build new image -->
              <exec command="docker">
                <arg>build</arg>
                <arg>-t</arg>
                <arg>pearl-hello-world</arg>
                <arg>.</arg>
              </exec>
              <!-- Run container -->
              <exec command="docker">
                <arg>run</arg>
                <arg>-d</arg>
                <arg>--name</arg>
                <arg>pearl-hello-world</arg>
                <arg>-p</arg>
                <arg>9292:9292</arg>
                <arg>pearl-hello-world</arg>
              </exec>
              <!-- Health check -->
              <exec command="sleep">
                <arg>10</arg>
              </exec>
              <exec command="curl">
                <arg>-f</arg>
                <arg>http://localhost:9292/health</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
    </pipeline>
  </pipelines>
</cruise>