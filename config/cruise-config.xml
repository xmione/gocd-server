<!-- config/cruise-config.xml -->
<!-- config/cruise-config.xml -->
<cruise schemaVersion="139">
  <server agentAutoRegisterKey="default" serverId="__SERVER_ID__" tokenGenerationKey="__TOKEN_GENERATION_KEY__">
    <security>
      <authConfigs>
        <authConfig id="password_file" pluginId="cd.go.authentication.passwordfile">
          <property>
            <key>PasswordFilePath</key>
            <value>/godata/config/password.properties</value>
          </property>
        </authConfig>
      </authConfigs>
      <roles>
        <role name="gocd-system-administrators">
          <users>
            <user>admin</user>
          </users>
        </role>
      </roles>
      <admins>
        <user>admin</user>
      </admins>
    </security>
  </server>

  <pipelines group="defaultGroup">
    <pipeline name="badminton_court">
      <materials>
        <git url="__GIT_REPO_URL_WITH_CREDENTIALS__" branch="master" />
      </materials>
      <stage name="build">
        <jobs>
          <job name="build_job">
            <resources>
              <resource>docker</resource>
            </resources>
            <tasks>
              <!-- PROVEN CLEANUP BLOCK -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>
                  echo "========================================================" &amp;&amp;
                  echo "AGGRESSIVE CLEANUP OF badminton-court" &amp;&amp;
                  echo "========================================================" &amp;&amp;
                  echo "Forcefully removing specific containers by name..." &amp;&amp;
                  docker rm -f web-dev || echo "Container 'web-dev' not found." &amp;&amp;
                  docker rm -f db || echo "Container 'db' not found." &amp;&amp;
                  docker rm -f mail-test || echo "Container 'mail-test' not found." &amp;&amp;
                  docker rm -f redis || echo "Container 'redis' not found." &amp;&amp;
                  echo "Running docker-compose down to clean up networks, volumes, etc..." &amp;&amp;
                  cd /badminton_court &amp;&amp;
                  docker-compose -f docker-compose.yml --env-file .env.docker -p badminton-court down -v --remove-orphans || echo "docker-compose down had issues, but continuing." &amp;&amp;
                  echo "Pruning dangling images..." &amp;&amp;
                  docker image prune -f
                </arg>
              </exec>

              <!-- ORIGINAL TASKS -->
              <!-- Convert line endings and decrypt environment files -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; sed -i 's/\r$//' Scripts/decryptenvfiles.sh &amp;&amp; bash Scripts/decryptenvfiles.sh</arg>
              </exec>
              <!-- Stop any existing containers -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker -p badminton-court down</arg>
              </exec>
              <!-- Build dev profile service images without cache -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker --profile dev --progress=plain build --no-cache</arg>
              </exec>
              <!-- Force recreate dev containers -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker --profile dev -p badminton-court up -d --force-recreate</arg>
              </exec>
              <!-- Show service status -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker --profile dev -p badminton-court ps</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
    </pipeline>
    
    <pipeline name="badminton_court-test">
      <materials>
        <git url="__GIT_REPO_URL_WITH_CREDENTIALS__" branch="master" />
      </materials>
      <stage name="build_test">
        <jobs>
          <job name="test_job">
            <resources>
              <resource>docker</resource>
            </resources>
            <tasks>
              <!-- Only build the test profile -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker --profile test --progress=plain build --no-cache</arg>
              </exec>
              <!-- Then run the tests -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker --profile test up --abort-on-container-exit</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
    </pipeline>

    <pipeline name="badminton_court-presentation">
      <materials>
        <git url="__GIT_REPO_URL_WITH_CREDENTIALS__" branch="master" />
      </materials>
      <stage name="build_presentation">
        <jobs>
          <job name="presentation_job">
            <resources>
              <resource>docker</resource>
            </resources>
            <tasks>
              <!-- Only build the presentation profile -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker --profile presentation --progress=plain build --no-cache</arg>
              </exec>
              <!-- Then run the presentations -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker --profile presentation up --abort-on-container-exit</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
    </pipeline>

    <pipeline name="badminton_court-tunnel">
      <materials>
        <git url="__GIT_REPO_URL_WITH_CREDENTIALS__" branch="master" />
      </materials>
      <stage name="build_tunnel">
        <jobs>
          <job name="tunnel_job">
            <resources>
              <resource>docker</resource>
            </resources>
            <tasks>
              <!-- Only build the tunnel profile -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker --profile tunnel --progress=plain build --no-cache</arg>
              </exec>
              <!-- Then run the tunnel -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /badminton_court &amp;&amp; docker-compose -f docker-compose.yml --env-file .env.docker --profile tunnel up --abort-on-container-exit</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
    </pipeline>

    <pipeline name="pearl-hello-world">
      <materials>
        <git url="__GIT_REPO_URL_WITH_CREDENTIALS__" branch="master" />
      </materials>
      <stage name="build">
        <jobs>
          <job name="build_job">
            <resources>
              <resource>docker</resource>
            </resources>
            <tasks>
              <!-- PROVEN CLEANUP BLOCK -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>
                  echo "========================================================" &amp;&amp;
                  echo "CLEANING UP pearl-hello-world" &amp;&amp;
                  echo "========================================================" &amp;&amp;
                  docker rm -f pearl-hello-world || echo "Container 'pearl-hello-world' not found." &amp;&amp;
                  docker rmi -f pearl-hello-world || echo "Image 'pearl-hello-world' not found." &amp;&amp;
                  docker image prune -f
                </arg>
              </exec>

              <!-- ORIGINAL TASKS -->
              <!-- Debug task to verify directory -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /pearl-hello-world &amp;&amp; pwd &amp;&amp; ls -la</arg>
              </exec>
              <!-- Build new image from the correct directory -->
              <exec command="bash">
                <arg>-c</arg>
                <arg>cd /pearl-hello-world &amp;&amp; docker build -t pearl-hello-world .</arg>
              </exec>
              <!-- Run container -->
              <exec command="docker">
                <arg>run</arg>
                <arg>-d</arg>
                <arg>--name</arg>
                <arg>pearl-hello-world</arg>
                <arg>-p</arg>
                <arg>9292:9292</arg>
                <arg>pearl-hello-world</arg>
              </exec>
              <!-- Health check using Docker host IP -->
              <exec command="sleep">
                <arg>10</arg>
              </exec>
              <exec command="bash">
                <arg>-c</arg>
                <arg>curl -f http://$(ip route | grep default | awk '{print $3}'):9292/health || curl -f http://host.docker.internal:9292/health || echo "Container is running but health check failed"</arg>
              </exec>
            </tasks>
          </job>
        </jobs>
      </stage>
    </pipeline>
  </pipelines>
</cruise>